<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수능 모의고사 타이머</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
        }
        .subject-button {
            transition: all 0.2s ease-in-out;
        }
        .subject-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .subject-button.active {
            background-color: #4f46e5; /* Tailwind indigo-600 */
            color: white;
            transform: translateY(0px);
            box-shadow: none;
        }
        canvas {
            width: 100%;
            height: auto;
            max-width: 400px;
            aspect-ratio: 1 / 1;
        }
        .log-calendar-grid {
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl mx-auto bg-white rounded-2xl shadow-xl p-4 md:p-8">
        <div class="md:flex md:gap-8">
            <!-- 좌측: 시계 및 디스플레이 -->
            <div class="md:w-1/2 flex flex-col items-center justify-center p-4">
                <header class="text-center mb-4 w-full relative">
                    <h1 class="text-3xl md:text-4xl font-bold text-indigo-600">수능 모의고사 타이머</h1>
                     <button id="mute-button" class="absolute top-1/2 right-0 -translate-y-1/2 p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <!-- Speaker Icon SVG -->
                    </button>
                    <p id="subject-display" class="text-gray-500 mt-2 text-lg min-h-[3.5rem] md:min-h-[1.75rem]">과목을 선택하여 타이머를 시작하세요.</p>
                </header>
                <canvas id="analog-clock"></canvas>
                <div id="digital-display" class="text-center text-4xl sm:text-5xl font-mono tracking-tighter mt-4 text-gray-700 h-12"></div>
            </div>

            <!-- 우측: 컨트롤 패널 -->
            <div class="md:w-1/2 p-4 flex flex-col justify-center mt-8 md:mt-0">
                <div id="mode-selection-tabs" class="flex border-b mb-4">
                    <button id="exam-mode-tab" class="px-4 py-2 font-semibold border-b-2 border-indigo-600 text-indigo-600">📝 시험 모드</button>
                    <button id="study-mode-tab" class="px-4 py-2 font-semibold text-gray-500">📚 일반 학습</button>
                </div>

                <!-- 시험 모드 UI -->
                <div id="exam-mode-panel">
                    <div id="subject-buttons-container" class="grid grid-cols-2 gap-3">
                         <button data-id="korean" class="subject-button col-span-2 bg-gray-200 hover:bg-gray-300 p-3 rounded-lg"><span class="font-bold">1교시 국어</span><span class="block text-xs text-gray-600">08:40 ~ 10:00</span></button>
                         <button data-id="math" class="subject-button col-span-2 bg-gray-200 hover:bg-gray-300 p-3 rounded-lg"><span class="font-bold">2교시 수학</span><span class="block text-xs text-gray-600">10:30 ~ 12:10</span></button>
                         <button data-id="english" class="subject-button col-span-2 bg-gray-200 hover:bg-gray-300 p-3 rounded-lg"><span class="font-bold">3교시 영어</span><span class="block text-xs text-gray-600">13:10 ~ 14:20</span></button>
                         <button data-id="history" class="subject-button col-span-2 bg-gray-200 hover:bg-gray-300 p-3 rounded-lg"><span class="font-bold">4교시 한국사</span><span class="block text-xs text-gray-600">14:50 ~ 15:20</span></button>
                         <button data-id="inquiry1" class="subject-button bg-gray-200 hover:bg-gray-300 p-3 rounded-lg"><span class="font-bold">탐구 1</span><span class="block text-xs text-gray-600">15:35 ~ 16:05</span></button>
                         <button data-id="inquiry2" class="subject-button bg-gray-200 hover:bg-gray-300 p-3 rounded-lg"><span class="font-bold">탐구 2</span><span class="block text-xs text-gray-600">16:07 ~ 16:37</span></button>
                    </div>
                    <div id="initial-buttons-container" class="mt-4">
                        <button id="full-exam-mode-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-lg font-bold text-lg transition-colors">💯 전체 모의고사 모드</button>
                    </div>
                </div>

                <!-- 일반 학습 모드 UI -->
                <div id="study-mode-panel" class="hidden text-center">
                    <p class="text-gray-600 mb-2">오늘의 총 학습 시간</p>
                    <p id="total-study-time-display" class="text-3xl font-bold mb-4">00:00:00</p>
                    <div id="study-timer-display" class="text-5xl font-mono text-indigo-600 mb-6">00:00:00</div>
                    <button id="study-timer-toggle" class="w-full bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg font-bold text-lg transition-colors">학습 시작</button>
                    <button id="view-log-button" class="mt-3 w-full bg-gray-200 hover:bg-gray-300 p-3 rounded-lg font-semibold text-gray-700">학습 기록 보기</button>
                </div>
                
                <!-- 공용 컨트롤 버튼 -->
                <div id="control-buttons-container" class="mt-6 space-y-3">
                    <div id="single-mode-controls">
                         <button id="pause-button" class="hidden w-full bg-amber-500 hover:bg-amber-600 text-white p-4 rounded-lg font-bold text-lg transition-colors">일시 정지</button>
                        <div id="paused-controls" class="hidden flex gap-4">
                            <button id="resume-button" class="w-1/2 bg-indigo-500 hover:bg-indigo-600 text-white p-4 rounded-lg font-bold text-lg transition-colors">재시작</button>
                            <button id="reset-button" class="w-1/2 bg-gray-700 hover:bg-gray-800 text-white p-4 rounded-lg font-bold text-lg transition-colors">초기화</button>
                        </div>
                    </div>
                    <div id="full-exam-mode-controls" class="hidden space-y-3">
                        <button id="skip-button" class="w-full bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg font-bold text-lg transition-colors">다음으로 (스킵)</button>
                        <button id="full-exam-reset-button" class="w-full bg-gray-700 hover:bg-gray-800 text-white p-4 rounded-lg font-bold text-lg transition-colors">처음으로 돌아가기</button>
                    </div>
                    <div id="end-of-exam-controls" class="hidden">
                        <button id="return-to-start-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-lg font-bold text-lg transition-colors">처음으로 돌아가기</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 학습 기록 모달 -->
    <div id="log-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-2xl font-bold text-indigo-600">📅 학습 기록</h2>
                <button id="close-log-modal" class="p-2 rounded-full hover:bg-gray-200">&times;</button>
            </div>
            <div id="log-calendar-container">
                <!-- 달력 헤더 -->
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month-btn" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">&lt;</button>
                    <h3 id="calendar-month-year" class="text-xl font-semibold"></h3>
                    <button id="next-month-btn" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">&gt;</button>
                </div>
                <!-- 달력 본문 -->
                <div class="grid log-calendar-grid gap-1 text-center">
                    <div class="font-semibold text-red-500">일</div>
                    <div class="font-semibold">월</div>
                    <div class="font-semibold">화</div>
                    <div class="font-semibold">수</div>
                    <div class="font-semibold">목</div>
                    <div class="font-semibold">금</div>
                    <div class="font-semibold text-blue-500">토</div>
                </div>
                <div id="calendar-dates" class="grid log-calendar-grid gap-1 mt-1">
                    <!-- 날짜가 동적으로 채워집니다. -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 전역 변수 ---
        let timerInterval = null, realTimeInterval = null, studyTimerInterval = null;
        let timerState = 'stopped', fullExamModeActive = false, isMuted = false, isStudyTimerRunning = false;
        let currentSession = {}, timerStartTime = 0, elapsedTimeOnPause = 0, currentScheduleIndex = -1;
        let lastSessionEndTimeMs = 0, currentAudio = null, studyTimerStartTime = 0;
        let calendarDate = new Date();

        // --- 상수 ---
        const audios = {
            korean_warning: 'audio/006 0950 1교시 종료10분전.mp3', korean_end: 'audio/007 1000 1교시 종료령.mp3',
            math_warning: 'audio/012 1200 2교시 종료10분전.mp3', math_end: 'audio/013 1210 2교시 종료령.mp3',
            english_warning: 'audio/017 1410 3교시 종료10분전.mp3', english_end: 'audio/018 1420 3교시 종료령.mp3',
            history_warning: 'audio/023 1515 4교시 한국사 종료5분전.mp3', history_end: 'audio/024 1520 4교시 한국사 종료령.mp3',
            inquiry1_warning: 'audio/027 1555 4교시 탐구 첫째종료5분전.mp3', inquiry1_end: 'audio/028 1600 4교시 탐구 첫째종료령.mp3',
            inquiry2_warning: 'audio/030 1627 4교시 탐구 둘째종료5분전.mp3', inquiry2_end: 'audio/031 1632 4교시 탐구 둘째종료령.mp3',
        };
        const subjects = {
            korean:  { name: '1교시 국어', duration: 80, startH: 8, startM: 40, warningTime: 10, audioKey: 'korean', endDuration: 8 },
            math:    { name: '2교시 수학', duration: 100, startH: 10, startM: 30, warningTime: 10, audioKey: 'math', endDuration: 8 },
            english: { name: '3교시 영어', duration: 70, startH: 13, startM: 10, warningTime: 10, audioKey: 'english', endDuration: 8 },
            history: { name: '4교시 한국사', duration: 30, startH: 14, startM: 50, warningTime: 5, audioKey: 'history', endDuration: 9.5 },
            inquiry1:{ name: '4교시 탐구 1', duration: 30, startH: 15, startM: 35, warningTime: 5, audioKey: 'inquiry1', endDuration: 9.5 },
            inquiry2:{ name: '4교시 탐구 2', duration: 30, startH: 16, startM: 7, warningTime: 5, audioKey: 'inquiry2', endDuration: 9.5 },
        };
        const fullExamSchedule = [
            { type: 'exam', subjectId: 'korean' }, { type: 'break', name: '쉬는 시간', duration: 30 },
            { type: 'exam', subjectId: 'math' }, { type: 'break', name: '점심 시간', duration: 60 },
            { type: 'exam', subjectId: 'english' }, { type: 'break', name: '쉬는 시간', duration: 30 },
            { type: 'exam', subjectId: 'history' }, { type: 'break', name: '쉬는 시간', duration: 15 },
            { type: 'exam', subjectId: 'inquiry1' }, { type: 'break', name: '문제지 교체', duration: 2 },
            { type: 'exam', subjectId: 'inquiry2' },
        ];
        const speakerIcons = {
            unmuted: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`,
            muted: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>`
        };

        // --- DOM 요소 ---
        const subjectDisplay = document.getElementById('subject-display'), digitalDisplay = document.getElementById('digital-display');
        const muteButton = document.getElementById('mute-button');
        const canvas = document.getElementById('analog-clock'), ctx = canvas.getContext('2d');
        let radius;
        // 탭 & 패널
        const examModeTab = document.getElementById('exam-mode-tab'), studyModeTab = document.getElementById('study-mode-tab');
        const examModePanel = document.getElementById('exam-mode-panel'), studyModePanel = document.getElementById('study-mode-panel');
        // 시험 모드
        const fullExamModeButton = document.getElementById('full-exam-mode-button'), skipButton = document.getElementById('skip-button'), fullExamResetButton = document.getElementById('full-exam-reset-button');
        const pauseButton = document.getElementById('pause-button'), pausedControls = document.getElementById('paused-controls');
        const resumeButton = document.getElementById('resume-button'), resetButton = document.getElementById('reset-button');
        const endOfExamControls = document.getElementById('end-of-exam-controls'), returnToStartButton = document.getElementById('return-to-start-button');
        // 학습 모드
        const totalStudyTimeDisplay = document.getElementById('total-study-time-display'), studyTimerDisplay = document.getElementById('study-timer-display');
        const studyTimerToggle = document.getElementById('study-timer-toggle'), viewLogButton = document.getElementById('view-log-button');
        // 모달
        const logModal = document.getElementById('log-modal'), closeLogModal = document.getElementById('close-log-modal');
        const calendarMonthYear = document.getElementById('calendar-month-year'), calendarDates = document.getElementById('calendar-dates');
        const prevMonthBtn = document.getElementById('prev-month-btn'), nextMonthBtn = document.getElementById('next-month-btn');

        // --- 초기화 및 설정 ---
        function resizeAndDrawCanvas() {
            const size = Math.min(canvas.parentElement.clientWidth, 400);
            canvas.width = size; canvas.height = size;
            ctx.setTransform(1, 0, 0, 1, 0, 0); ctx.translate(size / 2, size / 2);
            radius = (size / 2) * 0.90;
            if (timerState === 'stopped') {
                updateRealTimeClock();
            }
        }

        // --- 시계 그리기 ---
        function drawClock(timeMs) {
            drawFace(ctx, radius); drawNumbers(ctx, radius); drawTime(ctx, radius, timeMs);
        }
        function drawFace(ctx, radius) {
            if (!radius || radius <= 0) return;
            ctx.clearRect(-radius*1.2, -radius*1.2, radius*2.4, radius*2.4);
            ctx.beginPath(); ctx.arc(0, 0, radius, 0, 2 * Math.PI); ctx.fillStyle = '#ffffff'; ctx.fill();
            const grad = ctx.createRadialGradient(0, 0, radius * 0.95, 0, 0, radius * 1.05);
            grad.addColorStop(0, '#e5e7eb'); grad.addColorStop(0.5, '#f9fafb'); grad.addColorStop(1, '#e5e7eb');
            ctx.strokeStyle = grad; ctx.lineWidth = radius * 0.1; ctx.stroke();
            ctx.beginPath(); ctx.arc(0, 0, radius * 0.05, 0, 2 * Math.PI); ctx.fillStyle = '#1f2937'; ctx.fill();
        }
        function drawNumbers(ctx, radius) {
            if (!radius || radius <= 0) return;
            ctx.font = radius * 0.15 + "px 'Inter'"; ctx.textBaseline = "middle"; ctx.textAlign = "center"; ctx.fillStyle = '#374151';
            for (let num = 1; num <= 12; num++) {
                const ang = num * Math.PI / 6;
                ctx.rotate(ang); ctx.translate(0, -radius * 0.85); ctx.rotate(-ang);
                ctx.fillText(num.toString(), 0, 0);
                ctx.rotate(ang); ctx.translate(0, radius * 0.85); ctx.rotate(-ang);
            }
        }
        function drawTime(ctx, radius, simulatedTimeMs) {
            if (!radius || radius <= 0) return;
            const totalSeconds = Math.floor(simulatedTimeMs / 1000);
            const s = totalSeconds % 60, m = Math.floor(totalSeconds / 60) % 60, h = Math.floor(totalSeconds / 3600);
            const secondAngle = s * (Math.PI / 30), minuteAngle = (m + s / 60) * (Math.PI / 30), hourAngle = ((h % 12) + m / 60 + s / 3600) * (Math.PI / 6);
            drawHand(ctx, hourAngle, radius * 0.5, radius * 0.07, '#4b5563');
            drawHand(ctx, minuteAngle, radius * 0.8, radius * 0.05, '#1f2937');
            drawHand(ctx, secondAngle, radius * 0.9, radius * 0.02, '#ef4444');
        }
        function drawHand(ctx, pos, length, width, color) {
            ctx.beginPath(); ctx.lineWidth = width; ctx.lineCap = "round"; ctx.strokeStyle = color;
            ctx.moveTo(0, 0); ctx.rotate(pos); ctx.lineTo(0, -length); ctx.stroke(); ctx.rotate(-pos);
        }

        // --- 타이머 로직 ---
        function updateRealTimeClock() {
            const now = new Date();
            const timeMs = (now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds()) * 1000;
            drawClock(timeMs);
        }
        function startRealTimeClock() { stopAllTimers(); updateRealTimeClock(); realTimeInterval = setInterval(updateRealTimeClock, 1000); }
        function stopAllTimers() { clearInterval(timerInterval); clearInterval(realTimeInterval); clearInterval(studyTimerInterval); timerInterval = null; realTimeInterval = null; studyTimerInterval = null; }

        // 시험 모드 로직
        function updateTimer() {
            const elapsedMs = Date.now() - timerStartTime;
            const remainingMs = (currentSession.duration * 60 * 1000) - elapsedMs;
            if (remainingMs <= 0) { stopAndFinishTimer(); return; }
            let sessionStartTimeMs = (currentSession.type === 'exam') ? (currentSession.subject.startH * 3600 + currentSession.subject.startM * 60) * 1000 : currentSession.startTimeMs;
            drawClock(sessionStartTimeMs + elapsedMs);
            digitalDisplay.textContent = formatTime(remainingMs / 1000);
            if (currentSession.type === 'exam' && !currentSession.warningPlayed) {
                const warningTimeMs = currentSession.subject.warningTime * 60 * 1000;
                if (remainingMs < warningTimeMs + 500 && remainingMs > warningTimeMs - 500) {
                    playAlarm(currentSession.subject.audioKey + '_warning');
                    currentSession.warningPlayed = true;
                }
            }
        }
        function startSession(session) {
            stopAllTimers();
            currentSession = session;
            if (session.type === 'exam') {
                currentSession.subject = subjects[session.subjectId];
                currentSession.name = currentSession.subject.name;
                currentSession.duration = currentSession.subject.duration;
            } else { currentSession.startTimeMs = lastSessionEndTimeMs; }
            currentSession.warningPlayed = false;
            subjectDisplay.textContent = `[ ${currentSession.name} ] 진행 중...`;
            timerStartTime = Date.now(); timerState = 'running';
            updateTimer(); timerInterval = setInterval(updateTimer, 1000);
            showRunningUI();
        }
        function startFullExamMode() { fullExamModeActive = true; currentScheduleIndex = 0; startNextSession(); }
        function startNextSession() {
            if (!fullExamModeActive || currentScheduleIndex >= fullExamSchedule.length) {
                subjectDisplay.textContent = "전체 모의고사가 종료되었습니다!";
                setTimeout(resetTimer, 5000); return;
            }
            startSession(fullExamSchedule[currentScheduleIndex]);
        }
        function pauseTimer() {
            if (timerState !== 'running') return;
            stopAllTimers();
            elapsedTimeOnPause = Date.now() - timerStartTime;
            timerState = 'paused'; subjectDisplay.textContent += " (일시 정지됨)";
            showPausedUI();
        }
        function resumeTimer() {
            if (timerState !== 'paused') return;
            timerStartTime = Date.now() - elapsedTimeOnPause;
            timerState = 'running'; subjectDisplay.textContent = `[ ${currentSession.name} ] 진행 중...`;
            updateTimer(); timerInterval = setInterval(updateTimer, 1000);
            showRunningUI();
        }
        function resetTimer() {
            stopAllTimers();
            timerState = 'stopped'; currentSession = {};
            timerStartTime = 0; elapsedTimeOnPause = 0; fullExamModeActive = false; currentScheduleIndex = -1;
            lastSessionEndTimeMs = 0;
            subjectDisplay.textContent = "과목을 선택하여 타이머를 시작하세요.";
            digitalDisplay.textContent = ""; document.title = "수능 모의고사 타이머";
            startRealTimeClock(); showInitialUI();
        }
        function stopAndFinishTimer() {
            stopAllTimers();
            timerState = 'stopped';
            digitalDisplay.textContent = "00:00:00";
            if (currentSession.type === 'exam') {
                subjectDisplay.textContent = `${currentSession.name} 시험이 종료되었습니다.`;
                playAlarm(currentSession.subject.audioKey + '_end', currentSession.subject.endDuration);
                lastSessionEndTimeMs = (currentSession.subject.startH * 3600 + currentSession.subject.startM * 60 + currentSession.subject.duration * 60) * 1000;
            } else { 
                subjectDisplay.textContent = `[ ${currentSession.name} ] 종료!`;
                lastSessionEndTimeMs = currentSession.startTimeMs + (currentSession.duration * 60 * 1000); 
            }
            if (fullExamModeActive) {
                const nextSessionIndex = currentScheduleIndex + 1;
                if (nextSessionIndex < fullExamSchedule.length) {
                    const nextSession = fullExamSchedule[nextSessionIndex];
                    const nextSessionName = nextSession.type === 'exam' ? subjects[nextSession.subjectId].name : nextSession.name;
                    subjectDisplay.textContent = `다음은 [ ${nextSessionName} ] 입니다. (${nextSession.duration}분)`;
                }
                currentScheduleIndex++;
                setTimeout(startNextSession, 3000);
            } else { 
                showEndOfSingleExamUI();
            }
        }
        function skipSession() { if (fullExamModeActive) stopAndFinishTimer(); }

        // 학습 모드 로직
        function toggleStudyTimer() {
            if (isStudyTimerRunning) { // Stop
                isStudyTimerRunning = false;
                const elapsedSeconds = Math.floor((Date.now() - studyTimerStartTime) / 1000);
                saveStudyTime(elapsedSeconds);
                clearInterval(studyTimerInterval);
                studyTimerInterval = null;
                studyTimerToggle.textContent = '학습 시작';
                studyTimerToggle.classList.replace('bg-red-500', 'bg-green-500');
                studyTimerToggle.classList.replace('hover:bg-red-600', 'hover:bg-green-600');
            } else { // Start
                isStudyTimerRunning = true;
                studyTimerStartTime = Date.now();
                studyTimerToggle.textContent = '학습 종료';
                studyTimerToggle.classList.replace('bg-green-500', 'bg-red-500');
                studyTimerToggle.classList.replace('hover:bg-green-600', 'hover:bg-red-600');
                updateStudyTimerDisplay();
                studyTimerInterval = setInterval(updateStudyTimerDisplay, 1000);
            }
        }
        function updateStudyTimerDisplay() {
            const elapsedSeconds = Math.floor((Date.now() - studyTimerStartTime) / 1000);
            studyTimerDisplay.textContent = formatTime(elapsedSeconds);
        }
        function loadTotalStudyTime() {
            const todayKey = new Date().toISOString().slice(0, 10);
            const studyLog = JSON.parse(localStorage.getItem('studyLog') || '{}');
            const totalSeconds = studyLog[todayKey] || 0;
            totalStudyTimeDisplay.textContent = formatTime(totalSeconds);
        }
        function saveStudyTime(seconds) {
            const todayKey = new Date().toISOString().slice(0, 10);
            const studyLog = JSON.parse(localStorage.getItem('studyLog') || '{}');
            const currentTotal = studyLog[todayKey] || 0;
            studyLog[todayKey] = currentTotal + seconds;
            localStorage.setItem('studyLog', JSON.stringify(studyLog));
            loadTotalStudyTime();
        }
        
        // 학습 기록 모달 로직
        function renderCalendar() {
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            calendarMonthYear.textContent = `${year}년 ${month + 1}월`;

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            calendarDates.innerHTML = '';

            const studyLog = JSON.parse(localStorage.getItem('studyLog') || '{}');

            for (let i = 0; i < firstDay; i++) {
                calendarDates.insertAdjacentHTML('beforeend', '<div></div>');
            }

            for (let date = 1; date <= lastDate; date++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const totalSeconds = studyLog[dateKey] || 0;
                const studyTimeFormatted = totalSeconds > 0 ? formatTime(totalSeconds, true) : '';
                const isToday = new Date().toDateString() === new Date(year, month, date).toDateString();
                
                const dateCellHTML = `
                    <div class="p-1 border rounded ${isToday ? 'bg-indigo-100' : ''} h-24 flex flex-col justify-between">
                        <span class="font-semibold ${date === 1 ? 'text-left' : ''}">${date}</span>
                        <span class="text-xs font-bold text-indigo-700">${studyTimeFormatted}</span>
                    </div>
                `;
                calendarDates.insertAdjacentHTML('beforeend', dateCellHTML);
            }
        }


        // --- 유틸리티 함수 ---
        function formatTime(totalSeconds, short = false) {
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = Math.floor(totalSeconds % 60);
            if (short) {
                let result = '';
                if (h > 0) result += `${h}h `;
                if (m > 0) result += `${m}m`;
                return result.trim() || '0m';
            }
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }
        function playAlarm(audioType, durationLimit = null) {
            if (isMuted) return;
            if (currentAudio) { currentAudio.pause(); }
            const audioSrc = audios[audioType];
            if (audioSrc) {
                currentAudio = new Audio(audioSrc);
                currentAudio.play().catch(e => console.error("오디오 재생 오류:", e));
                if (durationLimit) {
                    setTimeout(() => {
                        if (currentAudio && !currentAudio.paused) {
                            currentAudio.pause();
                            currentAudio.currentTime = 0;
                        }
                    }, durationLimit * 1000);
                }
            }
        }
        
        // --- UI 상태 변경 ---
        function showInitialUI() {
            document.getElementById('control-buttons-container').classList.add('hidden');
            document.getElementById('single-mode-controls').classList.add('hidden');
            document.getElementById('full-exam-mode-controls').classList.add('hidden');
            document.getElementById('end-of-exam-controls').classList.add('hidden');
            examModePanel.classList.remove('hidden');
        }
        function showRunningUI() {
            examModePanel.classList.add('hidden');
            document.getElementById('control-buttons-container').classList.remove('hidden');
            if (fullExamModeActive) {
                document.getElementById('single-mode-controls').classList.add('hidden');
                document.getElementById('full-exam-mode-controls').classList.remove('hidden');
            } else {
                document.getElementById('single-mode-controls').classList.remove('hidden');
                pauseButton.classList.remove('hidden');
                pausedControls.classList.add('hidden');
                document.getElementById('full-exam-mode-controls').classList.add('hidden');
            }
            document.getElementById('end-of-exam-controls').classList.add('hidden');
        }
        function showPausedUI() { pauseButton.classList.add('hidden'); pausedControls.classList.remove('hidden'); }
        function showEndOfSingleExamUI() {
            document.getElementById('single-mode-controls').classList.add('hidden');
            document.getElementById('full-exam-mode-controls').classList.add('hidden');
            document.getElementById('end-of-exam-controls').classList.remove('hidden');
        }
        function updateMuteButtonUI() { muteButton.innerHTML = isMuted ? speakerIcons.muted : speakerIcons.unmuted; }
        
        // --- 이벤트 리스너 ---
        document.querySelectorAll('.subject-button').forEach(button => {
            button.addEventListener('click', () => startSession({ type: 'exam', subjectId: button.dataset.id }));
        });
        fullExamModeButton.addEventListener('click', startFullExamMode);
        pauseButton.addEventListener('click', pauseTimer);
        resumeButton.addEventListener('click', resumeTimer);
        resetButton.addEventListener('click', resetTimer);
        skipButton.addEventListener('click', skipSession);
        fullExamResetButton.addEventListener('click', resetTimer);
        returnToStartButton.addEventListener('click', resetTimer);
        muteButton.addEventListener('click', () => { isMuted = !isMuted; updateMuteButtonUI(); });
        
        examModeTab.addEventListener('click', () => {
            if(isStudyTimerRunning) return;
            examModeTab.classList.add('border-indigo-600', 'text-indigo-600');
            examModeTab.classList.remove('text-gray-500');
            studyModeTab.classList.remove('border-indigo-600', 'text-indigo-600');
            studyModeTab.classList.add('text-gray-500');
            examModePanel.classList.remove('hidden');
            studyModePanel.classList.add('hidden');
            resetTimer();
        });
        studyModeTab.addEventListener('click', () => {
            if(timerState !== 'stopped') return;
            studyModeTab.classList.add('border-indigo-600', 'text-indigo-600');
            studyModeTab.classList.remove('text-gray-500');
            examModeTab.classList.remove('border-indigo-600', 'text-indigo-600');
            examModeTab.classList.add('text-gray-500');
            studyModePanel.classList.remove('hidden');
            examModePanel.classList.add('hidden');
            resetTimer();
            digitalDisplay.textContent = "";
            subjectDisplay.textContent = "일반 학습 타이머";
        });

        studyTimerToggle.addEventListener('click', toggleStudyTimer);
        viewLogButton.addEventListener('click', () => {
            calendarDate = new Date();
            renderCalendar();
            logModal.classList.remove('hidden');
        });
        closeLogModal.addEventListener('click', () => logModal.classList.add('hidden'));
        prevMonthBtn.addEventListener('click', () => {
            calendarDate.setMonth(calendarDate.getMonth() - 1);
            renderCalendar();
        });
        nextMonthBtn.addEventListener('click', () => {
            calendarDate.setMonth(calendarDate.getMonth() + 1);
            renderCalendar();
        });

        window.addEventListener('resize', resizeAndDrawCanvas);
        window.addEventListener('load', () => {
            resizeAndDrawCanvas();
            loadTotalStudyTime();
            startRealTimeClock();
        });

        // --- 최초 실행 ---
        showInitialUI();
        updateMuteButtonUI();
    </script>
</body>
</html>
